<!DOCTYPE html>
<html style="padding:0;margin:0;">
	<body style="padding:0;margin:0;overflow: hidden;">
		<canvas id="screen"></canvas>
		<script>
			function randomRange(low, high){
				var difference = high-low;
				var output = Math.random();
				output = Math.round(output*(difference+0.99)-0.5)+low;
				return output;
			}
			var canvas = document.getElementById('screen');
			var ctx = canvas.getContext('2d');
			function canvasResize() {
				canvas.width  = window.innerWidth;
				canvas.height = window.innerHeight;
				ctx.fillStyle = '#23272A';
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			}
			canvasResize();
			window.onresize = canvasResize;
			ctx.fillStyle = '#23272A';
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			ctx.font = "120px Arial";
			ctx.fillStyle = '#7289DA';
			ctx.fillText("click for boids :D", 100, canvas.height-120);
			var boids = []
			var distances = []

			//function dist(bo1d, bo2d){
			//	xdist = boids[bo1d].x - boids[bo2d].x
			//	ydist = boids[bo1d].y - boids[bo2d].y
			//	return [xdist, ydist]
			//}
			function dist(bo1d, hivex, hivey){
				xdist = hivex - bo1d.x
				ydist = hivey - bo1d.y
				if(ydist >= 0){
					originangle = Math.atan(xdist/ydist)
					//console.log("no pi")
				} else {
					originangle = Math.atan(xdist/ydist)+Math.PI
					//console.log("+pi")
				}
				return [xdist, ydist, originangle]
			}
			function addParticlesOnClick(event){
				var x = event.clientX;
				var y = event.clientY;
				for(var i = 0; i < 1; i++){
					boid = new Boid();
					if(100>x){
						x = 100
					} else if(x>canvas.width-100) {
						x = canvas.width-100
					}
					if(100>y){
						y = 100
					} else if(y>canvas.height-100) {
						y = canvas.height-100
					}
					boid.x = x + randomRange(-50, 50)
					boid.y = y + randomRange(-50, 50)
					boids.push(boid)
					if(boids.length>40){
						boids.shift();
					}
				}
				
			}
			var mouseX = 0
			var mouseY = 0
			function onMouseMove(event){
				if(boids.length > 0){
					mouseX = event.pageX + 'px';
					mouseY = event.pageY + 'px';
					//if(100>mouseX){
					//	mouseX = 100
					//} else if(mouseX>canvas.width-100) {
					//	mouseX = canvas.width-100
					//}
					//if(100>mouseY){
					//	mouseY = 100
					//} else if(mouseY>canvas.height-100) {
					//	mouseY = canvas.height-100
					//}
				}
			}

			canvas.addEventListener('mousemove', onMouseMove);
			canvas.addEventListener('mousedown', addParticlesOnClick);

			function line(x, y, angle, length, color){
					ctx.lineWidth = 3;
					ctx.strokeStyle = color
					ctx.beginPath();
					ctx.moveTo(x, y);
					ctx.lineTo(x + length*Math.sin(angle), y + length*Math.cos(angle));
					ctx.closePath();
					ctx.stroke();
			}

			class Boid{
				constructor(){
					this.x = randomRange(0, canvas.width)
					this.y = randomRange(0, canvas.height)
					this.angle = 2*Math.random()*Math.PI
					this.va = 0
					this.speed = randomRange(3, 12)
					this.size = randomRange(7, 9)
				}
				draw(hivex, hivey, index){
					var distance = []
					distance = dist(this, hivex, hivey)
					var xspeed = 0
					var yspeed = 0

					if(-20<this.x<canvas.width+20 && -20<this.y<canvas.height+20){
						ctx.lineWidth = this.size;
						ctx.strokeStyle = 'red'
						ctx.lineJoin = 'round';
						ctx.beginPath();
						ctx.moveTo(this.x, this.y);
						ctx.lineTo(this.x+this.size*Math.sin(this.angle+1.35*Math.PI), this.y+this.size*Math.cos(this.angle+1.35*Math.PI));
						ctx.lineTo(this.x+this.size*1.3*Math.sin(this.angle), this.y+this.size*1.3*Math.cos(this.angle));
						ctx.lineTo(this.x+this.size*Math.sin(this.angle+0.65*Math.PI), this.y+this.size*Math.cos(this.angle+0.65*Math.PI));
						ctx.lineTo(this.x, this.y);
						ctx.closePath();
						ctx.stroke();

						//line(this.x, this.y, distance[2], Math.sqrt(Math.pow(distance[0], 2)+Math.pow(distance[1], 2))/6, 'green');
						//line(this.x, this.y, Math.PI/2, distance[0]/6, 'yellow');
						//line(this.x, this.y, Math.PI, -distance[1]/6, 'yellow');
					}					

					//var dit = Math.sqrt(Math.pow(distance[0], 2)+Math.pow(distance[1], 2)) // distance to center
					//var grav = Math.pow(Math.abs(dit/300)+1, 2) // gravity inverse square, but capped
					
					var avoidx = 0
					var avoidy = 0

					for(var i = 0; i < boids.length; i++){
						if(index != i){
							var boidist = dist(this, boids[i].x, boids[i].y);
							var boiddit = Math.sqrt(Math.pow(boidist[0], 2)+Math.pow(boidist[1], 2)); // distance to boid
							if(boiddit < 23){
								boiddit = 23;
							} else if(boiddit > 397){
								boiddit = 397
							}
							//var repel = (16+boids.length)/Math.pow(0.1*(Math.abs(boiddit)-16), 2)+Math.pow((boiddit-120), 2)/5000-0.85;
							var repel = -(boiddit-50)*(boiddit-250)*(boiddit-350)/(20000*(boiddit-20)) + 0.3;
							avoidx = avoidx + repel*Math.sin(boidist[2]);
							avoidy = avoidy + repel*Math.cos(boidist[2]);
				
							//line(this.x, this.y, boiddit[2], boidist, 'pink');
							//console.log(boidist, boiddit, repel)
						}
					}
					avoidx = avoidx/boids.length;
					avoidy = avoidy/boids.length;
					
					var quadx
					var quady
					var windx = 0
					var windy = 0
					quadx = Math.round((8*this.x-canvas.width/2)/canvas.width)
					quady = Math.round((8*this.y-canvas.height/2)/canvas.height)
					//console.log(quadx, quady)
					if(50>=this.x){
						windx = 1.2
					} else if(this.x>=canvas.width-50) {
						windx = -1.2
					} else {
						var check1 = 1
					}
						
					if(50>=this.y){
						windy = 1.2
					} else if(this.y>=canvas.height-50) {
						windy = -1.2
					} else {
						var check2 = 1
					}
						
					if(check1 && check2){
						windx = Math.sin(wind[quadx][quady])
						windy = Math.cos(wind[quadx][quady])
					}


					xspeed = (this.speed * Math.sin(this.angle) - avoidx + windx/14)*0.9;
					yspeed = (this.speed * Math.cos(this.angle) - avoidy + windy/14)*0.9;

					
					//console.log(xspeed, yspeed);
					if(-20>xspeed>20){
						xspeed = 10
					}
					if(-20>yspeed>20){
						yspeed = 10
					}
					var va = 0
					if(yspeed >= 0){
						//console.log("down")
						this.va = Math.atan(xspeed/yspeed) - this.angle

					} else {
						this.va = Math.atan(xspeed/yspeed)+Math.PI - this.angle
						//console.log("up")
					}
					var turnspeed = 48
					if(this.va > Math.PI/turnspeed){
						this.va = Math.PI/turnspeed
					} else if(this.va < -Math.PI/turnspeed) {
						this.va = -Math.PI/turnspeed
					}
					this.angle = this.angle + this.va
					this.speed = Math.sqrt(Math.pow(xspeed, 2)+Math.pow(yspeed, 2))
					this.x = this.x + xspeed;
					this.y = this.y + yspeed;
					//console.log(this.x, this.y);
				}
			}
			wind = [
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0]

			]
			for(var i = 0; i < 8; i++){
				for(var j = 0; j < 8; j++){
				wind[i][j] = 2*Math.random()*Math.PI
				}
			}
			setInterval(function(){
		
				if(boids.length != 0){
					rando = randomRange(0,3)
					if(rando == 0){
						eggs = randomRange(0,3)
						why = randomRange(0,3)
						wind[eggs][why] = 2*Math.random()*Math.PI
						//console.log(wind)
					}
					
					ctx.fillStyle = '#23272A';
					ctx.fillRect(0, 0, canvas.width, canvas.height);

					for(var i = 0; i < boids.length; i++){
						boids[i].draw(mouseX, mouseY, i);
					}
					ctx.font = "120px Arial";
					ctx.fillStyle = '#7289DA';
					strboid = boids.length.toString()
					ctx.fillText(boids.length, canvas.width-69*strboid.length-60, 120);
				}

			}, 10)

		</script>
	</body>
</html>