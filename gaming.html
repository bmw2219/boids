<!DOCTYPE html>
<html style="padding:0;margin:0;">
	<body style="padding:0;margin:0;overflow: hidden;">
		<canvas id="screen"></canvas>
		<script>
			function randomRange(low, high){
				var difference = high-low;
				var output = Math.random();
				output = Math.round(output*difference)+low;
				return output;
			}
			var canvas = document.getElementById('screen');
			var ctx = canvas.getContext('2d');
			function canvasResize() {
				canvas.width  = window.innerWidth;
				canvas.height = window.innerHeight;
				ctx.fillStyle = '#23272A';
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			}
			canvasResize();
			window.onresize = canvasResize;
			ctx.fillStyle = 'black';
			ctx.fillRect(0, 0, canvas.width, canvas.height);

			var boids = []
			var distances = []

			//function dist(bo1d, bo2d){
			//	xdist = boids[bo1d].x - boids[bo2d].x
			//	ydist = boids[bo1d].y - boids[bo2d].y
			//	return [xdist, ydist]
			//}
			function dist(bo1d, hivex, hivey){
				xdist = hivex - bo1d.x
				ydist = hivey - bo1d.y
				if(ydist >= 0){
					originangle = Math.atan(xdist/ydist)
					//console.log("no pi")
				} else {
					originangle = Math.atan(xdist/ydist)+Math.PI
					//console.log("+pi")
				}
				return [xdist, ydist, originangle]
			}
			function addParticlesOnClick(event){
				var x = event.clientX;
				var y = event.clientY;
				for(var i = 0; i < 1; i++){
					boid = new Boid();
					if(100>x){
						x = 100
					} else if(x>canvas.width-100) {
						x = canvas.width-100
					}
					if(100>y){
						y = 100
					} else if(y>canvas.height-100) {
						y = canvas.height-100
					}
					boid.x = x + randomRange(-50, 50)
					boid.y = y + randomRange(-50, 50)
					boids.push(boid)
					if(boids.length>80){
						boids.shift();
					}
				}
				
			}
			canvas.addEventListener('mousedown', addParticlesOnClick);

			function line(x, y, angle, length, color){
					ctx.lineWidth = 3;
					ctx.strokeStyle = color
					ctx.beginPath();
					ctx.moveTo(x, y);
					ctx.lineTo(x + length*Math.sin(angle), y + length*Math.cos(angle));
					ctx.closePath();
					ctx.stroke();
			}

			class Boid{
				constructor(){
					this.x = randomRange(0, canvas.width)
					this.y = randomRange(0, canvas.height)
					this.angle = 2*Math.random()*Math.PI
					this.speed = randomRange(3, 12)
					this.size = 9
				}
				draw(hivex, hivey, index){
					var distance = []
					distance = dist(this, hivex, hivey)
					var xspeed = 0
					var yspeed = 0

					if(-20<this.x<canvas.width+20 && -20<this.y<canvas.height+20){
						ctx.lineWidth = 8;
						ctx.strokeStyle = 'red'
						ctx.lineJoin = 'round';
						ctx.beginPath();
						ctx.moveTo(this.x, this.y);
						ctx.lineTo(this.x+this.size*Math.sin(this.angle+1.35*Math.PI), this.y+this.size*Math.cos(this.angle+1.35*Math.PI));
						ctx.lineTo(this.x+this.size*1.3*Math.sin(this.angle), this.y+this.size*1.3*Math.cos(this.angle));
						ctx.lineTo(this.x+this.size*Math.sin(this.angle+0.65*Math.PI), this.y+this.size*Math.cos(this.angle+0.65*Math.PI));
						ctx.lineTo(this.x, this.y);
						ctx.closePath();
						ctx.stroke();

						line(this.x, this.y, distance[2], Math.sqrt(Math.pow(distance[0], 2)+Math.pow(distance[1], 2))/6, 'green');
						//line(this.x, this.y, Math.PI/2, distance[0]/6, 'yellow');
						//line(this.x, this.y, Math.PI, -distance[1]/6, 'yellow');
					}					

					var dit = Math.sqrt(Math.pow(distance[0], 2)+Math.pow(distance[1], 2)) // distance to center
					var grav = Math.pow(Math.abs(dit/300)+1, 2) // gravity inverse square, but capped
					
					var avoidx = 0
					var avoidy = 0
					for(var i = 0; i < boids.length; i++){
						if(index != i){
							var boidist = dist(this, boids[i].x, boids[i].y);
							var boiddit = Math.sqrt(Math.pow(boidist[0], 2)+Math.pow(boidist[1], 2)); // distance to boid
							if(boiddit < 19){
								boiddit = 19;
							}
							var repel = (16+boids.length)/Math.pow(0.1*(Math.abs(boiddit)-16), 2); // gravity inverse square, but capped
							avoidx = avoidx + repel*Math.sin(boidist[2]);
							avoidy = avoidy + repel*Math.cos(boidist[2]);
							line(this.x, this.y, boiddit[2], boidist, 'pink');
							//console.log(boidist, boiddit, repel)
						}
					}
					avoidx = avoidx/boids.length;
					avoidy = avoidy/boids.length;
					if(Math.round(avoidx, avoidy)!=0){
						console.log(Math.round(avoidx, avoidy));
					}
					xspeed = (this.speed * Math.sin(this.angle) + Math.sin(distance[2])/grav - avoidx)*0.9;
					yspeed = (this.speed * Math.cos(this.angle) + Math.cos(distance[2])/grav - avoidy)*0.9;
					//console.log(xspeed, yspeed);
					if(-20>xspeed>20){
						xspeed = 10
					}
					if(-20>yspeed>20){
						yspeed = 10
					}
					if(yspeed >= 0){
						//console.log("down")
						this.angle = Math.atan(xspeed/yspeed)
					} else {
						this.angle = Math.atan(xspeed/yspeed)+Math.PI
						//console.log("up")
					}
					this.speed = Math.sqrt(Math.pow(xspeed, 2)+Math.pow(yspeed, 2))
					this.x = this.x + xspeed;
					this.y = this.y + yspeed;
					//console.log(this.x, this.y);
				}
			}
			brain = new Boid;
			brain.x = canvas.width/2
			brain.y = canvas.height/2
			brain.angle = 0 // vx
			brain.speed = 0 // vy
			setInterval(function(){
				ctx.fillStyle = '#23272A';
				ctx.fillRect(0, 0, canvas.width, canvas.height);

				if(boids.length != 0){
					hivex = 0
					hivey = 0
					for(var i = 0; i < boids.length; i++){
						hivex = hivex + boids[i].x;
						hivey = hivey + boids[i].y;
						//console.log(boids[i].x, boids[i].y)
					}
					hivex = hivex/boids.length;
					hivey = hivey/boids.length;
					//console.log(hivex, hivey, boids.length)
					brain.angle = (brain.angle + brain.x - hivex)/1.5
					brain.speed = (brain.speed + brain.y - hivey)/1.5

					if(150>hivex){
						brain.speed = brain.speed + 60
					} else if(hivex>canvas.width-200) {
						brain.speed = brain.speed - 60
					}
					if(150>hivey){
						brain.angle = brain.angle + 60
					} else if(hivey>canvas.height-200) {
						brain.angle = brain.angle - 60
					}

					brain.x = brain.x - brain.angle/20
					brain.y = brain.y - brain.speed/20
					//console.log(vxy)
					ctx.fillStyle = 'gray';
					ctx.arc(brain.x, brain.y, 10, 0, 2 * Math.PI);
					ctx.fill();
					//ctx.fillStyle = 'white';
					//ctx.arc(hivex, hivey, 10, 0, 2 * Math.PI);
					//ctx.fill();
					//console.log(boids.length);
	
					for(var i = 0; i < boids.length; i++){
						boids[i].draw(brain.x, brain.y, i);
					}
				}

			}, 12)

		</script>
	</body>
</html>